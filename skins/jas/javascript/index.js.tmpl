##    Copyright (c) 2021-2022 Rich Bell <bellrichm@gmail.com>
##    See the file LICENSE.txt for your rights.

// Send log messages from the parent page to the child iframe.
function logIt(message) {
  //console.log(message)
  // When running without a webserver, there is a lot of 'strangeness'
  if (window.location.protocol == "file:") {
      targetOrigin = "*";
  }
  else {
      targetOrigin = window.location.origin;
  }      

  forwardedMessage = {};
  forwardedMessage.kind = 'log';
  forwardedMessage.message = message;
  document.getElementById('child-iframe').contentWindow.postMessage(forwardedMessage, targetOrigin);
}  
  
## ToDo thiscould be cleaned up
function setIframeSrc(id, url) {
  // Set current page as the active page.
  currentPage = sessionStorage.getItem('currentPage');
  if (currentPage != url) {
    currentPageId = document.getElementById(currentPage);
    if (currentPageId) {
      currentPageId.classList.remove("active");
    }
    sessionStorage.setItem('currentPage', url);
  }
  document.getElementById(url).classList.add("active");
  document.getElementById(id).src = url;

  ## ToDo - better way/location?
  // When on the debug iframe, add the connect/disconnect buttons to the header.
  // The need to be on the parent page because the MQTT connection is on the parent. 
  if (url == 'debug.html') {
    document.getElementById('connectButton').classList.remove("d-none");
    document.getElementById('disconnectButton').classList.remove("d-none");
  }
  else {
    document.getElementById('connectButton').classList.add("d-none");
    document.getElementById('disconnectButton').classList.add("d-none");      
  }
}


// Handle a year being selected
function setYear(year) {
  // Handle 'year' and 'month' click/selections
  var makeonClickHandler = function(url) {
          return function onClickHandler() {
                setIframeSrc("child-iframe", url);
          };
  };

  var list = document.getElementById("dropdownYearMonthMenu");
  list.innerHTML = "";

  // Add the year to the top of the month dropdown.
  var li = document.createElement("li");
  var link = document.createElement("a"); 
  link.classList.add("dropdown-item");           
  var url = "pages/" + year + ".html";
  link.id = url;
  link.onclick = makeonClickHandler(url);

  var text = document.createTextNode(year);
  link.appendChild(text);
  li.appendChild(link);
  list.appendChild(li);

  // Add a divider between the year amd months.
  var divider = document.createElement("div");
  divider.classList.add("dropdown-divider");
  list.appendChild(divider);

  // Add each month to the drop down.
  for (var i = 0; i < yearMonth[year].length; i++) {
    li = document.createElement("li");
    link = document.createElement("a"); 
    link.classList.add("dropdown-item");
    url = "pages/" + yearMonth[year][i] + ".html";
    link.id = url;
    link.onclick = makeonClickHandler(url);

    var currentPage = sessionStorage.getItem('currentPage');
    if (currentPage && currentPage == url) {
      link.id = url;
    }
  
    text = document.createTextNode(yearMonth[year][i]);
    link.appendChild(text);
    li.appendChild(link);
    list.appendChild(li);
  }
}

window.addEventListener("load", function (event) {
  ## ToDo - proof of concept, charting MQTT data
  #for observation in $observations
    #if "mqtt" in $observations[$observation]["aggregate_types"]
      #set mqtt_data = $observation + "MQTT"
      sessionStorage.setItem('$mqtt_data', JSON.stringify([]));
    #end if
  #end for

  var list = document.getElementById("dropdownYearMenu");
  list.innerHTML = "";
  list.currentSelection = null;

  // Handle year selected/click
  var setActiveYear = function() {
    var list = document.getElementById("dropdownYearMenu");
    var currentSelection = sessionStorage.getItem('currentSelection');
    if (this.id != currentSelection) {
        if (currentSelection) {
            document.getElementById(currentSelection).classList.remove("active");
        }
        this.classList.add("active");
        sessionStorage.setItem('currentSelection', this.id);
    }
    setYear(this.innerHTML);
  };

  // build year drop down
  for (var year in yearMonth){
    var li = document.createElement("li");
    var link = document.createElement("a"); 
    link.classList.add("dropdown-item");
    ## ToDo - better id?          
    link.id = year;

    var text = document.createTextNode(year);
    link.onclick = setActiveYear;
    link.appendChild(text);
    link.href = "#";
    li.appendChild(link);
    list.appendChild(li);
    var currentSelection = sessionStorage.getItem('currentSelection');
    if (currentSelection && currentSelection == year) {
      link.classList.add("active");
      sessionStorage.setItem('currentSelection', link.id);
      setYear(link.innerHTML);
    }
  }

  if (sessionStorage.getItem('currentPage') === null) {
      sessionStorage.setItem('currentPage', '');
      ## ToDo - configure landing page
      setIframeSrc('child-iframe', 'pages/last24hours.html');
  }
  else
  {
      setIframeSrc('child-iframe', sessionStorage.getItem('currentPage'));  
  }

  ## ToDo - put here for now, only include if necessary
  ## ToDo - convert to boolean
  #if $Extras.mqtt.enable.lower() == 'true'
    MQTTConnect(); 
  #end if
});

window.addEventListener("beforeunload", function (event) {
  if(sessionStorage.getItem("MQTTConnected")){
    MQTTDisconnect();
  }
});

window.addEventListener('message', 
                        function(e) {
                          // message that was passed from iframe page
                          var message = e.data;

                          var iframe = document.querySelector("#child-iframe");
                          iframe.style.height = message.height + 'px';
                          //iframe.style.width = message.width + 'px';
                        }, 
                        false);       

